<ion-header>
  <ion-toolbar class="modern-toolbar">
    
    <ion-title class="page-title">
      <div class="title-content">
        <h1>Inventory</h1>
        <!-- <p class="page-subtitle">Manage your products and stock levels</p> -->
      </div>
    </ion-title>
    
 <ion-buttons slot="end">
  <ion-button (click)="openAddCategoryModal()" class="add-category-btn" >
    <i class="fas fa-layer-group"></i>
    Add Category
  </ion-button>
</ion-buttons>

  </ion-toolbar>
</ion-header>


<ion-content class="modern-inventory-content">
  <!-- Search and Filter Section -->
  <section class="search-filter-section">
    <div class="search-container">
      <div class="search-box">
        <!-- <i class="fas fa-search search-icon"></i> -->
        <ion-searchbar 
          placeholder="Search products..." 
          (ionInput)="searchProducts($event)"
          [value]="searchTerm"
          class="modern-searchbar">
        </ion-searchbar>
      </div>
    </div>

 <div class="categories-container">
  <ion-segment [value]="selectedCategory" (ionChange)="filterByStockStatus($event)" class="modern-segment">
    <ion-segment-button value="all" class="category-btn">
      <ion-label>All</ion-label>
    </ion-segment-button>
    <ion-segment-button value="in-stock" class="category-btn">
      <ion-label>In Stock</ion-label>
    </ion-segment-button>
    <ion-segment-button value="low-stock" class="category-btn">
      <ion-label>Low Stock</ion-label>
    </ion-segment-button>
    <ion-segment-button value="out-of-stock" class="category-btn">
      <ion-label>Out of Stock</ion-label>
    </ion-segment-button>
  </ion-segment>
</div>

  </section>

  <!-- Swipe Hint -->
  <div class="swipe-hint" *ngIf="filteredProducts.length > 0">
    <i class="fas fa-arrow-left"></i>
    <span>Swipe left on items to reveal actions</span>
  </div>

  <!-- Products List -->
  <section class="products-section">
    <div class="section-header">
      <div class="header-content">
        <div class="title-section">
          <h2>Product Inventory</h2>
          <p>{{ filteredProducts.length }} products found</p>
        </div>
        <ion-button (click)="openAddProductModal()" class="add-product-btn" fill="solid">
          <i class="fas fa-plus"></i>
          Add Product
        </ion-button>
<ion-button fill="clear" (click)="openUpdateInventoryModal(); $event.stopPropagation()">
  <i class="fas fa-boxes"></i> Update Qty
</ion-button>

      </div>
    </div>

    <ion-list class="modern-product-list">
      <ion-item-sliding *ngFor="let product of filteredProducts" class="product-slide">
        <ion-item (click)="editProduct(product)" class="product-item">
          <ion-avatar slot="start" class="product-avatar">
            <ion-img [src]="product.image" [alt]="product.name"></ion-img>
            <div class="stock-badge" [class.low-stock]="product.quantity < 10" [class.warning-stock]="product.quantity >= 10 && product.quantity < 20">
              {{ product.quantity }}
            </div>
          </ion-avatar>
          
          <ion-label class="product-details">
            <h3 class="product-name">{{ product.name }}</h3>
            <div class="product-meta">
              <span class="product-category">
                <i class="fas fa-tag"></i>
                {{ product.category }}
              </span>
              <span class="product-barcode">
                <i class="fas fa-barcode"></i>
                {{ product.barcode || 'No barcode' }}
              </span>
            </div>
            <div class="product-price">
              <span class="price">₱{{ product.price | number:'1.2-2' }}</span>
              <span class="stock-status" 
                    [class.low-stock]="product.quantity < 10" 
                    [class.warning-stock]="product.quantity >= 10 && product.quantity < 20"
                    [class.in-stock]="product.quantity >= 20">
                <i class="fas" 
                   [class.fa-check-circle]="product.quantity >= 20"
                   [class.fa-exclamation-triangle]="product.quantity >= 10 && product.quantity < 20"
                   [class.fa-exclamation-circle]="product.quantity < 10"></i>
                {{ getStockStatus(product.quantity).label }}
              </span>
            </div>
          </ion-label>

          <div class="quick-actions" slot="end">
            <ion-button fill="clear" class="action-btn" (click)="editProduct(product); $event.stopPropagation()">
              <i class="fas fa-edit"></i>
            </ion-button>
          </div>
        </ion-item>

        <ion-item-options side="end" class="slide-options">
          <ion-item-option (click)="editProduct(product)" class="edit-option">
            <div class="option-content">
              <i class="fas fa-edit"></i>
              <span>Edit</span>
            </div>
          </ion-item-option>
          <ion-item-option (click)="deleteProduct(product.id!, product.name)" class="delete-option">
            <div class="option-content">
              <i class="fas fa-trash"></i>
              <span>Delete</span>
            </div>
          </ion-item-option>
        </ion-item-options>
      </ion-item-sliding>
    </ion-list>

    <!-- Empty State -->
    <div class="modern-empty-state" *ngIf="filteredProducts.length === 0">
      <div class="empty-icon">
        <i class="fas fa-cube"></i>
      </div>
      <h3>No products found</h3>
      <p *ngIf="searchTerm || selectedCategory !== 'all'">Try adjusting your search or filter criteria</p>
      <p *ngIf="!searchTerm && selectedCategory === 'all'">Add your first product to get started</p>
      <ion-button (click)="openAddProductModal()" fill="solid" class="add-first-btn">
        <i class="fas fa-plus"></i>
        Add Your First Product
      </ion-button>
    </div>
  </section>
</ion-content>

<!-- Enhanced Add/Edit Product Modal -->
<ion-modal [isOpen]="isModalOpen" (didDismiss)="closeModal()" class="modern-product-modal">
  <ng-template>
    <ion-header class="modal-header">
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button (click)="closeModal()" class="close-btn">
            <i class="fas fa-arrow-left"></i>
          </ion-button>
        </ion-buttons>
        
        <ion-title class="modal-title">
          <h2>{{ isEditing ? 'Edit Product' : 'Add New Product' }}</h2>
          <p>{{ isEditing ? 'Update product details' : 'Create a new product entry' }}</p>
        </ion-title>
        
        <ion-buttons slot="end">
          <ion-button (click)="closeModal()" fill="clear" class="cancel-btn">
            Cancel
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    
    <ion-content class="modal-content">
      <form [formGroup]="productForm" (ngSubmit)="saveProduct()" class="product-form">
        <!-- Image Upload Section -->
        <div class="image-upload-section">
          <div class="image-preview-container">
            <div class="image-preview" [class.has-image]="productForm.get('image')?.value">
              <img [src]="productForm.get('image')?.value || 'https://images.unsplash.com/photo-1560472354-b33ff0c44a43?w=150'" alt="Product preview" />
              <div class="image-overlay">
                <i class="fas fa-camera"></i>
                <span>Change Image</span>
              </div>
            </div>
            <input 
              #fileInput 
              type="file" 
              accept="image/*" 
              (change)="onImageSelected($event)" 
              class="file-input"
            />
            <ion-button fill="clear" (click)="fileInput.click()" class="upload-btn">
              <i class="fas fa-cloud-upload-alt"></i>
              Upload Image
            </ion-button>
          </div>
        </div>

        <!-- Form Fields -->
        <div class="form-fields">
          <ion-list lines="none" class="form-list">
            <!-- Product Name -->
            <ion-item class="form-item">
              <ion-label position="stacked" class="form-label">
                <i class="fas fa-tag"></i>
                Product Name *
              </ion-label>
              <ion-input 
                formControlName="name" 
                type="text" 
                placeholder="Enter product name"
                class="form-input">
              </ion-input>
              <div class="error-message" *ngIf="productForm.get('name')?.invalid && productForm.get('name')?.touched">
                <i class="fas fa-exclamation-circle"></i>
                Product name is required
              </div>
            </ion-item>

            <!-- Category -->
           <ion-item class="form-item">
  <ion-label position="stacked" class="form-label">
    <i class="fas fa-layer-group"></i>
    Category *
  </ion-label>

  <!-- No hardcoded options -->
<ion-select formControlName="category" placeholder="Select category" class="form-select">
  <ion-select-option *ngFor="let cat of categories" [value]="cat">
    {{ cat | titlecase }}
  </ion-select-option>
</ion-select>

</ion-item>

  <!-- Net Weight -->
<ion-item class="form-item">
  <ion-label position="stacked" class="form-label">
    <i class="fas fa-weight"></i>
    Net Weight
  </ion-label>
  <ion-input
    formControlName="netWeight"
    type="text"
    placeholder="e.g. 250g, 500 ml, 1 kg"
    class="form-input">
  </ion-input>
  <div class="error-message" *ngIf="productForm.get('netWeight')?.invalid && productForm.get('netWeight')?.touched">
    <i class="fas fa-exclamation-circle"></i>
    Invalid net weight
  </div>
</ion-item>
            <!-- Price and Quantity Row -->
            <div class="form-row">
              <ion-item class="form-item half-width">
                <ion-label position="stacked" class="form-label">
                  <i class="fas fa-tag"></i>
                  Price (₱) *
                </ion-label>
                <ion-input 
                  formControlName="price" 
                  type="number" 
                  min="0" 
                  step="0.01" 
                  placeholder="0.00"
                  class="form-input">
                </ion-input>
                <div class="error-message" *ngIf="productForm.get('price')?.invalid && productForm.get('price')?.touched">
                  <i class="fas fa-exclamation-circle"></i>
                  Valid price is required
                </div>
              </ion-item>

              <ion-item class="form-item half-width">
                <ion-label position="stacked" class="form-label">
                  <i class="fas fa-boxes"></i>
                  Quantity *
                </ion-label>
                <ion-input 
                  formControlName="quantity" 
                  type="number" 
                  min="0" 
                  placeholder="0"
                  class="form-input">
                </ion-input>
                <div class="error-message" *ngIf="productForm.get('quantity')?.invalid && productForm.get('quantity')?.touched">
                  <i class="fas fa-exclamation-circle"></i>
                  Valid quantity is required
                </div>
              </ion-item>
            </div>

            <!-- Barcode -->
           <!-- Barcode -->
<ion-item class="form-item">
  <ion-label position="stacked" class="form-label">
    <i class="fas fa-barcode"></i>
    Barcode Number *
  </ion-label>

  <ion-input 
    formControlName="barcode"
    type="text"
    placeholder="Scan barcode"
    readonly
    class="form-input">
  </ion-input>

  <ion-button 
    slot="end"
    fill="clear"
    class="scan-btn"
    (click)="startBarcodeScan()">
    <i class="fas fa-camera"></i>
    Scan
  </ion-button>
</ion-item>

<!-- Scanner Video Preview -->
<!-- Scanner Video Preview -->
<div *ngIf="scanning" class="scanner-container">
  <video #addProductScannerPreview width="100%" height="240" autoplay muted playsinline></video>

  <ion-button expand="block" color="danger" (click)="stopBarcodeScan()">
    Stop Scan
  </ion-button>
</div>


          </ion-list>
        </div>
      </form>
    </ion-content>
    
    <ion-footer class="modal-footer">
      <ion-toolbar>
        <ion-grid class="footer-grid">
          <ion-row>
            <ion-col size="6">
              <ion-button (click)="closeModal()" fill="outline" expand="block" class="cancel-action-btn">
                <i class="fas fa-times"></i>
                Cancel
              </ion-button>
            </ion-col>
            <ion-col size="6">
              <ion-button 
                (click)="saveProduct()" 
                [disabled]="!productForm.valid"
                expand="block"
                class="save-action-btn">
                <i class="fas" [class.fa-save]="isEditing" [class.fa-plus]="!isEditing"></i>
                {{ isEditing ? 'Update' : 'Save' }} Product
              </ion-button>
            </ion-col>
          </ion-row>
        </ion-grid>
      </ion-toolbar>
    </ion-footer>
  </ng-template>
</ion-modal>

<!-- Add Category Modal -->
<ion-modal [isOpen]="isCategoryModalOpen" (didDismiss)="closeCategoryModal()" class="category-modal">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button (click)="closeCategoryModal()">
            <i class="fas fa-arrow-left"></i>
          </ion-button>
        </ion-buttons>
        <ion-title>Add Category</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeCategoryModal()" fill="clear">Cancel</ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content>
      <form [formGroup]="categoryForm" (ngSubmit)="saveCategory()" class="category-form">
        <ion-item>
          <ion-label position="stacked">Category Name *</ion-label>
          <ion-input formControlName="name" placeholder="Ex. Snacks"></ion-input>
        </ion-item>

        <div class="error-message" *ngIf="categoryForm.get('name')?.invalid && categoryForm.get('name')?.touched">
          <i class="fas fa-exclamation-circle"></i>
          Category name is required
        </div>
      </form>
    </ion-content>

    <ion-footer>
      <ion-toolbar>
        <ion-grid>
          <ion-row>
            <ion-col size="6">
              <ion-button expand="block" fill="outline" (click)="closeCategoryModal()">Cancel</ion-button>
            </ion-col>
            <ion-col size="6">
              <ion-button expand="block" [disabled]="!categoryForm.valid" (click)="saveCategory()">Save</ion-button>
            </ion-col>
          </ion-row>
        </ion-grid>
      </ion-toolbar>
    </ion-footer>
  </ng-template>
</ion-modal>

<ion-modal [isOpen]="updateInventoryModalOpen" (didDismiss)="closeUpdateInventoryModal()" class="update-inventory-modal">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button (click)="closeUpdateInventoryModal()">
            <i class="fas fa-times"></i>
          </ion-button>
        </ion-buttons>
        <ion-title>Update Inventory</ion-title>
      </ion-toolbar>
    </ion-header>

    <ion-content class="ion-padding">

      <!-- Scan Product Button (hide when scanning) -->
      <ion-button *ngIf="!inventoryScanning" expand="block" (click)="startInventoryScan()">
        <i class="fas fa-qrcode"></i> Scan Product Barcode
      </ion-button>

      <!-- Scanner Section (visible when scanning) -->
     <div *ngIf="inventoryScanning" class="scanner-container">
  <video #inventoryScannerPreview width="100%" height="240" autoplay></video>
  <ion-button expand="block" color="danger" (click)="stopInventoryScan()">Stop Scan</ion-button>
</div>


      <!-- Product Info + Add Quantity -->
      <div *ngIf="scannedProduct">
        <h3>{{ scannedProduct.name }}</h3>
        <p>Category: {{ scannedProduct.category }}</p>
        <p>Current Quantity: {{ scannedProduct.quantity }}</p>

        <ion-item>
          <ion-label position="stacked">Additional Quantity</ion-label>
          <ion-input type="number" [(ngModel)]="additionalQuantity" min="1"></ion-input>
        </ion-item>

        <ion-button fill="clear" class="action-btn" (click)="saveInventoryUpdate()">
          <i class="fas fa-boxes"></i> Update Quantity
        </ion-button>
      </div>

    </ion-content>
  </ng-template>
</ion-modal>

