<ion-header>
  <ion-toolbar class="modern-toolbar">
    <ion-title class="page-title">
      <div class="title-content">
        <h1>Inventory</h1>
      </div>
    </ion-title>

    <ion-buttons slot="end">
      <ion-button (click)="openAddCategoryModal()" class="add-category-btn">
        <i class="fas fa-layer-group"></i>
        Add Category
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="modern-inventory-content">
  <section class="search-filter-section">
    <div class="search-container">
      <div class="search-box">
        <ion-searchbar 
          placeholder="Search products..." 
          (ionInput)="searchProducts($event)" 
          [value]="searchTerm"
          class="modern-searchbar">
        </ion-searchbar>
      </div>
    </div>

    <div class="filter-container">
      <div class="filter-box">
        <i class="fas fa-filter filter-icon"></i>
        <ion-select 
          [value]="selectedCategory" 
          (ionChange)="filterByStockStatus($event)" 
          interface="popover" 
          class="custom-select">
          <ion-select-option value="all">All Status</ion-select-option>
          <ion-select-option value="in-stock">In Stock</ion-select-option>
          <ion-select-option value="low-stock">Low Stock</ion-select-option>
          <ion-select-option value="out-of-stock">Out of Stock</ion-select-option>
        </ion-select>
      </div>
    </div>
  </section>

  <div class="swipe-hint" *ngIf="filteredProducts.length > 0">
    <i class="fas fa-arrow-left"></i>
    <span>Swipe left on items to reveal actions</span>
  </div>

  <section class="products-section">
    <div class="section-header">
      
      <div class="title-section">
        <h2>Product Inventory</h2>
        <p>{{ filteredProducts.length }} products found</p>
      </div>

      <div class="header-actions">
        <ion-button fill="outline" class="update-qty-btn" (click)="openUpdateInventoryModal(); $event.stopPropagation()">
          <i class="fas fa-boxes"></i> Update Qty
        </ion-button>
        <ion-button fill="solid" class="add-product-btn" (click)="openAddProductModal()">
          <i class="fas fa-plus"></i>
          Add Product
        </ion-button>
      </div>

    </div>

    <ion-list class="modern-product-list">
      <ion-item-sliding *ngFor="let product of filteredProducts" class="product-slide">
        <ion-item (click)="editProduct(product)" class="product-item">
          <ion-avatar slot="start" class="product-avatar">
            <ion-img [src]="product.image" [alt]="product.name"></ion-img>
            <div class="stock-badge" [class.low-stock]="product.quantity < 10"
              [class.warning-stock]="product.quantity >= 10 && product.quantity < 20">
              {{ product.quantity }}
            </div>
          </ion-avatar>

          <ion-label class="product-details">
            <h3 class="product-name">{{ product.name }}</h3>
            <div class="product-meta">
              <span class="product-category">
                <i class="fas fa-tag"></i>
                {{ product.category }}
              </span>
              <span class="product-barcode">
                <i class="fas fa-barcode"></i>
                {{ product.barcode || 'No barcode' }}
              </span>
            </div>
            <div class="product-price">
              <span class="price">₱{{ product.price | number:'1.2-2' }}</span>
              <span class="stock-status" [class.low-stock]="product.quantity < 10"
                [class.warning-stock]="product.quantity >= 10 && product.quantity < 20"
                [class.in-stock]="product.quantity >= 20">
                <i class="fas" [class.fa-check-circle]="product.quantity >= 20"
                  [class.fa-exclamation-triangle]="product.quantity >= 10 && product.quantity < 20"
                  [class.fa-exclamation-circle]="product.quantity < 10"></i>
                {{ getStockStatus(product.quantity).label }}
              </span>
            </div>
          </ion-label>

          <div class="quick-actions" slot="end">
            <ion-button fill="clear" class="action-btn" (click)="editProduct(product); $event.stopPropagation()">
              <i class="fas fa-edit"></i>
            </ion-button>
          </div>
        </ion-item>

        <ion-item-options side="end" class="slide-options">
          <ion-item-option (click)="editProduct(product)" class="edit-option">
            <div class="option-content">
              <i class="fas fa-edit"></i>
              <span>Edit</span>
            </div>
          </ion-item-option>
          <ion-item-option (click)="deleteProduct(product.id!, product.name)" class="delete-option">
            <div class="option-content">
              <i class="fas fa-trash"></i>
              <span>Delete</span>
            </div>
          </ion-item-option>
        </ion-item-options>
      </ion-item-sliding>
    </ion-list>

    <div class="modern-empty-state" *ngIf="filteredProducts.length === 0">
      <div class="empty-icon">
        <i class="fas fa-cube"></i>
      </div>
      <h3>No products found</h3>
      <p *ngIf="searchTerm || selectedCategory !== 'all'">Try adjusting your search or filter criteria</p>
      <p *ngIf="!searchTerm && selectedCategory === 'all'">Add your first product to get started</p>
      <ion-button (click)="openAddProductModal()" fill="solid" class="add-first-btn">
        <i class="fas fa-plus"></i>
        Add Your First Product
      </ion-button>
    </div>
  </section>
</ion-content>

<ion-modal [isOpen]="isModalOpen" (didDismiss)="closeModal()" class="modern-product-modal">
  <ng-template>
    <ion-header class="modal-header no-border">
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button (click)="closeModal()" color="medium" class="close-btn">
            <i class="fas fa-times"></i>
          </ion-button>
        </ion-buttons>

        <ion-title class="modal-title">
          <h2>{{ isEditing ? 'Edit Product' : 'New Product' }}</h2>
        </ion-title>

        <ion-buttons slot="end">
          <ion-button (click)="saveProduct()" [disabled]="!productForm.valid" class="save-btn-header">
            {{ isEditing ? 'Update' : 'Save' }}
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content class="modal-content">
      <form [formGroup]="productForm" (ngSubmit)="saveProduct()" class="product-form">
        
        <div class="image-section">
          <div class="image-card" (click)="fileInput.click()" 
               [class.has-image]="productForm.get('image')?.value">
            
            <ng-container *ngIf="productForm.get('image')?.value; else noImage">
              <img [src]="productForm.get('image')?.value" alt="Product" class="uploaded-image" />
              <div class="edit-overlay">
                <i class="fas fa-pen"></i>
              </div>
            </ng-container>

            <ng-template #noImage>
              <div class="upload-placeholder">
                <div class="icon-circle">
                  <i class="fas fa-camera"></i>
                </div>
                <span>Upload Photo</span>
              </div>
            </ng-template>
          </div>
          <input #fileInput type="file" accept="image/*" (change)="onImageSelected($event)" hidden />
        </div>

        <div class="form-grid">
          
          <div class="form-group">
            <label>Product Name <span class="required">*</span></label>
            <ion-item lines="none" class="custom-input-item">
              <ion-input formControlName="name" type="text" placeholder="e.g. Chocolate Bar"></ion-input>
            </ion-item>
            <div class="error-text" *ngIf="productForm.get('name')?.invalid && productForm.get('name')?.touched">
              Name is required
            </div>
          </div>

          <div class="form-group">
            <label>Category <span class="required">*</span></label>
            <ion-item lines="none" class="custom-input-item">
              <ion-select formControlName="category" placeholder="Select Category" interface="popover">
                <ion-select-option *ngFor="let cat of categories" [value]="cat">
                  {{ cat | titlecase }}
                </ion-select-option>
              </ion-select>
              <i class="fas fa-chevron-down input-icon" slot="end"></i>
            </ion-item>
          </div>

          <div class="form-row">
            <div class="form-group half">
              <label>Net Weight</label>
              <ion-item lines="none" class="custom-input-item">
                <ion-input formControlName="netWeight" placeholder="e.g. 50g"></ion-input>
              </ion-item>
            </div>

            <div class="form-group half">
              <label>Quantity <span class="required">*</span></label>
              <ion-item lines="none" class="custom-input-item">
                <ion-input formControlName="quantity" type="number" min="0" placeholder="0"></ion-input>
              </ion-item>
            </div>
          </div>

          <div class="form-group">
            <label>Price (₱) <span class="required">*</span></label>
            <ion-item lines="none" class="custom-input-item price-item">
              <span slot="start" class="currency-symbol">₱</span>
              <ion-input formControlName="price" type="number" min="0" step="0.01" placeholder="0.00"></ion-input>
            </ion-item>
          </div>

          <div class="form-group">
            <label>Barcode <span class="required">*</span></label>
            <ion-item lines="none" class="custom-input-item barcode-item">
              <i class="fas fa-barcode input-icon-start" slot="start"></i>
              <ion-input formControlName="barcode" type="text" placeholder="Scan or type..." readonly></ion-input>
              <ion-button slot="end" fill="clear" class="scan-icon-btn" (click)="startBarcodeScan()">
                <i class="fas fa-camera"></i>
              </ion-button>
            </ion-item>
          </div>

          <div *ngIf="scanning" class="scanner-preview-box">
             <video #addProductScannerPreview width="100%" height="100%" autoplay muted playsinline></video>
             <div class="scan-overlay">
               <ion-button color="light" size="small" shape="round" (click)="stopBarcodeScan()">
                 Cancel Scan
               </ion-button>
             </div>
          </div>

        </div>
      </form>
    </ion-content>
  </ng-template>
</ion-modal>

<ion-modal [isOpen]="isCategoryModalOpen" (didDismiss)="closeCategoryModal()" class="category-modal">
  <ng-template>
    <ion-header class="modal-header no-border">
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button (click)="closeCategoryModal()" color="medium">
            <i class="fas fa-times"></i>
          </ion-button>
        </ion-buttons>
        <ion-title class="modal-title">
            <h2>Add Category</h2>
        </ion-title>
      </ion-toolbar>
    </ion-header>

    <ion-content class="modal-content">
      <div class="category-wrapper">
        
        <div class="icon-header">
            <div class="icon-circle">
                <i class="fas fa-tag"></i>
            </div>
            <p>Create a new category for your products</p>
        </div>

        <form [formGroup]="categoryForm" (ngSubmit)="saveCategory()" class="category-form">
            <div class="form-group">
                <label>Category Name <span class="required">*</span></label>
                <ion-item lines="none" class="custom-input-item">
                  <ion-input formControlName="name" placeholder="e.g. Snacks, Drinks, Electronics"></ion-input>
                </ion-item>
                <div class="error-text" *ngIf="categoryForm.get('name')?.invalid && categoryForm.get('name')?.touched">
                    Category name is required
                </div>
            </div>
        </form>

        <div class="action-buttons">
            <ion-button fill="outline" class="cancel-btn" (click)="closeCategoryModal()">
                Cancel
            </ion-button>
            <ion-button fill="solid" class="save-update-btn" (click)="saveCategory()" [disabled]="!categoryForm.valid">
                Save Category
            </ion-button>
        </div>

      </div>
    </ion-content>
  </ng-template>
</ion-modal>

<ion-modal [isOpen]="updateInventoryModalOpen" (didDismiss)="closeUpdateInventoryModal()" class="update-inventory-modal">
  <ng-template>
    <ion-header class="modal-header no-border">
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button (click)="closeUpdateInventoryModal()" color="medium">
            <i class="fas fa-times"></i>
          </ion-button>
        </ion-buttons>
        <ion-title class="modal-title">
            <h2>Update Stock</h2>
        </ion-title>
      </ion-toolbar>
    </ion-header>

    <ion-content class="modal-content">
      <div class="update-layout">
        
        <div class="scanner-card" [class.scanning]="inventoryScanning">
            <div *ngIf="!inventoryScanning && !scannedProduct" class="scan-placeholder" (click)="startInventoryScan()">
                <div class="scan-icon-circle">
                    <i class="fas fa-qrcode"></i>
                </div>
                <h3>Scan Barcode</h3>
                <p>Tap here to start scanning</p>
            </div>

            <div *ngIf="inventoryScanning" class="video-container">
                <video #inventoryScannerPreview width="100%" height="100%" autoplay></video>
                <div class="video-overlay">
                    <div class="scan-line"></div>
                    <ion-button color="light" size="small" shape="round" class="stop-btn" (click)="stopInventoryScan()">
                        Cancel
                    </ion-button>
                </div>
            </div>

            <div *ngIf="!inventoryScanning && scannedProduct" class="rescan-header">
                <ion-button fill="outline" size="small" shape="round" (click)="startInventoryScan()">
                    <i class="fas fa-camera"></i> &nbsp; Scan Different Item
                </ion-button>
            </div>
        </div>

        <div *ngIf="scannedProduct" class="product-result-card">
            <div class="product-info">
                <span class="category-badge">{{ scannedProduct.category }}</span>
                <h3 class="name">{{ scannedProduct.name }}</h3>
                
                <div class="stock-display">
                    <div class="label">Current Stock</div>
                    <div class="value">{{ scannedProduct.quantity }}</div>
                </div>
            </div>

            <div class="input-section">
                <label>Add Quantity</label>
                <ion-item lines="none" class="custom-input-item">
                    <i class="fas fa-plus slot-icon" slot="start"></i>
                    <ion-input type="number" [(ngModel)]="additionalQuantity" min="1" placeholder="Enter qty to add"></ion-input>
                </ion-item>
            </div>

            <ion-button expand="block" class="save-update-btn" (click)="saveInventoryUpdate()">
                Confirm Update
            </ion-button>
        </div>

      </div>
    </ion-content>
  </ng-template>
</ion-modal>